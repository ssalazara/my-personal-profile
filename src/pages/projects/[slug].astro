---
// src/pages/projects/[slug].astro
import { getSanityClient, urlFor } from '@/lib/sanityClient.ts';
import BaseLayout from '@/layouts/BaseLayout.astro';

// This is the core of Astro's static site generation for dynamic pages.
// It runs once at build time, fetches all projects, and tells Astro 
// which pages need to be generated (e.g., /projects/my-first-project).
export async function getStaticPaths() {
  const query = `*[_type == "project" && defined(slug.current)]{ "slug": slug.current }`;
  const client = getSanityClient({
    projectId: import.meta.env.PUBLIC_SANITY_PROJECT_ID,
    dataset: import.meta.env.PUBLIC_SANITY_DATASET,
  });
  const projects = await client.fetch(query);

  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

// For each generated page, Astro passes the 'slug' from the URL as a parameter.
const { slug } = Astro.params;

// Now, we fetch the full data for THIS SPECIFIC project using its unique slug.
const query = `*[_type == "project" && slug.current == $slug][0]`;
const client = getSanityClient({
  projectId: import.meta.env.PUBLIC_SANITY_PROJECT_ID,
  dataset: import.meta.env.PUBLIC_SANITY_DATASET,
});
const project = await client.fetch(query, { slug });

// This is a safety measure. If a project with that slug isn't found, redirect to the 404 page.
if (!project) {
  return Astro.redirect('/404');
}

const coverImageUrl = project.coverImage 
  ? urlFor(project.coverImage, client).width(1200).auto('format').url()
  : null;
---
<BaseLayout title={project.title}>
  <!-- 
    THE CHANGE: The <header> is now a direct child of the layout.
    It is no longer inside the constrained-width .project-page container.
  -->
  <header class="project-header">
    {coverImageUrl && <img src={coverImageUrl} alt={project.title} class="cover-image"/>}
  </header>
  
  <article class="project-page">
    <!-- 
      The <h1> is now inside the main article container for better
      readability and alignment with the rest of the content.
    -->
    <h1 class="project-title">{project.title}</h1>
    
    <div class="project-content">
      <p><em>(Page builder content will go here...)</em></p>
    </div>
  </article>
</BaseLayout>

<style>
  /* NEW: Style for the full-width header/banner container */
  .project-header {
    width: 100%;
    /* 
      THE CHANGE: Reducing height by ~35%. 450px * 0.65 â‰ˆ 290px.
      Let's round to a clean 300px.
    */
    max-height: 300px;
    overflow: hidden; /* Ensures the container respects the max-height */
  }

  /* The image itself should fill its container */
  .cover-image {
    width: 100%;
    height: 100%; /* Fill the container's height */
    object-fit: cover; /* This is key: it will crop the image nicely */
  }

  /* This remains our centered content container */
  .project-page {
    max-width: 960px;
    margin: auto;
    padding: 2rem 1.5rem 4rem;
  }
  
  /* NEW: Styles for the title, now inside the .project-page container */
  .project-title {
    font-size: clamp(2.5rem, 5vw, 3.5rem);
    color: var(--color-text-primary);
    line-height: 1.1;
    text-align: center;
    margin-bottom: 3rem;
  }

  .project-content {
    margin-top: 3rem;
  }
</style>